openapi: 3.0.3
info:
  title: "BThwani — Wallet (WLT) API"
  description: Core endpoints for the internal wallet and ledger service (WLT).
  contact:
    name: BThwani Support
    email: support@bthwani.com
  version: "0.0.0-seed"
servers:
  - url: https://api-dev.bthwani.com
    description: Dev
  - url: https://api-stage.bthwani.com
    description: Stage
  - url: https://api.bthwani.com
    description: Prod
tags:
  - name: PaymentIntents
    description: إدارة عمليات إنشاء واستعلام نوايا الدفع.
  - name: PaymentConfirmations
    description: تأكيد عمليات الدفع بعد موفري PSP.
  - name: Settlements
    description: تسويات وضبط مبالغ الالتقاط (capture) بعد التعديلات.
  - name: WalletWebhooks
    description: Webhooks صادرة من WLT إلى الخدمات الأخرى (مثل DSH) حول الاستردادات.
security:
  - bearerAuth: []
paths:
  /api/wlt/intents:
    post:
      tags: [PaymentIntents]
      operationId: wlt_intents_create
      summary: إنشاء نية دفع جديدة لطلب تابع لخدمة DSH أو خدمة أخرى.
      description: Creates a new wallet payment intent for an upstream order while enforcing idempotency.
      x-surface: APP-USER
      x-screen: app_user.checkout.payment
      x-action: create_payment_intent
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PaymentIntentCreateRequest'
      responses:
        '201':
          description: تم إنشاء نية الدفع.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentIntent'
        default:
          $ref: '#/components/responses/StandardError'
  /api/wlt/intents/{intent_id}:
    get:
      tags: [PaymentIntents]
      operationId: wlt_intents_get
      summary: استعلام حالة نية الدفع الحالية.
      description: Retrieves the latest state of an existing wallet payment intent.
      x-surface: APP-USER
      x-screen: app_user.checkout.payment
      x-action: poll_payment_intent
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/IntentId'
      responses:
        '200':
          description: بيانات نية الدفع الحالية.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentIntent'
        default:
          $ref: '#/components/responses/StandardError'
  /api/wlt/intents/{intent_id}/confirm:
    post:
      tags: [PaymentConfirmations]
      operationId: wlt_intents_confirm
      summary: تأكيد نية الدفع بعد رد مزود الدفع.
      description: Confirms a wallet payment intent using the PSP callback payload.
      x-surface: APP-USER
      x-screen: app_user.checkout.payment
      x-action: confirm_payment
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
        - $ref: '#/components/parameters/IntentId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PaymentConfirmationRequest'
      responses:
        '200':
          description: تم تأكيد نية الدفع.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentIntent'
        default:
          $ref: '#/components/responses/StandardError'
  /api/wlt/intents/{intent_id}/capture-adjust:
    post:
      tags: [Settlements]
      operationId: wlt_capture_adjust
      summary: تعديل قيمة الالتقاط بعد تغييرات في الطلب (مثل الاستبدال أو الإرجاع).
      description: Applies a capture delta to align wallet settlement amounts with downstream order changes.
      x-surface: SYSTEM
      x-screen: system.settlements.capture
      x-action: dsh_capture_adjust
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
        - $ref: '#/components/parameters/IntentId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CaptureAdjustRequest'
      responses:
        '200':
          description: تم تعديل قيمة الالتقاط.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentIntent'
        default:
          $ref: '#/components/responses/StandardError'
  /api/wlt/inbound/refunds:
    post:
      tags: [WalletWebhooks]
      operationId: wlt_refunds_inbound
      summary: Webhook لاستلام أحداث الاسترداد أو الـ chargeback من مزود الدفع.
      description: Ingests signed refund or chargeback events emitted by the PSP for wallet reconciliation.
      x-surface: SYSTEM
      x-screen: system.webhooks.refunds
      x-action: wlt_refund_webhook
      security:
        - webhookHmac: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WltRefundWebhook'
      responses:
        '204':
          description: تم قبول الحدث.
        default:
          $ref: '#/components/responses/StandardError'
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
    webhookHmac:
      type: apiKey
      in: header
      name: X-Signature
  parameters:
    IdempotencyKey:
      name: Idempotency-Key
      in: header
      required: true
      schema:
        type: string
      description: مفتاح يساعد على ضمان عدم تكرار عمليات الكتابة.
    IntentId:
      name: intent_id
      in: path
      required: true
      schema:
        type: string
      description: معرّف نية الدفع داخل WLT.
  responses:
    StandardError:
      description: RFC7807 problem+json envelope for error responses.
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/Problem'
          examples:
            canonical:
              summary: Canonical problem response
              description: Canonical problem response
              value:
                type: https://errors.bthwani.com/common/unexpected_error
                title: Unexpected error
                status: 500
                code: SVR-500-UNEXPECTED
                detail: An unexpected error occurred. Please retry.
                traceId: '00000000000000000000000000000000'
                errors: []
  schemas:
    Problem:
      type: object
      description: RFC7807-compliant error envelope with service catalog codes.
      required:
        - type
        - title
        - status
        - code
        - traceId
      properties:
        type:
          type: string
          format: uri
          description: Machine-readable problem type URI.
        title:
          type: string
          description: Human-readable summary of the error condition.
        status:
          type: integer
          description: HTTP status code applied to the response.
        code:
          type: string
          description: Service-specific error code following {SERVICE}-{HTTP}-{KEY}.
          pattern: '^[A-Z]{3}-[0-9]{3}-[A-Z0-9\-]+$'
        detail:
          type: string
          description: Additional context; must not contain raw PII.
        traceId:
          type: string
          description: Correlation identifier to link logs and traces.
        instance:
          type: string
          format: uri
          description: Optional URI reference to a support ticket or incident.
        errorCatalog:
          $ref: '#/components/schemas/ErrorCatalog'
        errors:
          type: array
          description: Field-level validation or domain errors.
          items:
            $ref: '#/components/schemas/ProblemDetail'
    ProblemDetail:
      type: object
      properties:
        field:
          type: string
          description: Field or entity associated with the error detail.
        message:
          type: string
          description: Localized, sanitized description safe for clients and logs.
    ErrorCode:
      type: string
      description: Application-specific standardized error code.
      pattern: '^[A-Z]{3}-[0-9]{3}-[A-Z0-9\-]+$'
      example: SVR-500-UNEXPECTED
    ErrorCatalog:
      type: array
      description: Enumerated catalog of standard error codes relevant to the context.
      minItems: 1
      uniqueItems: true
      items:
        $ref: '#/components/schemas/ErrorCode'
    PaymentIntentCreateRequest:
      type: object
      additionalProperties: false
      required:
        - amount
        - currency
        - order_reference
      properties:
        amount:
          type: integer
          minimum: 1
          description: قيمة الطلب بالعملة الأساسية (YER افتراضيًا).
        currency:
          type: string
          minLength: 3
          maxLength: 3
          description: رمز العملة على ISO-4217 (YER افتراضيًا).
        order_reference:
          type: string
          maxLength: 64
          description: معرّف الطلب في الخدمة المستهلكة (مثل DSH).
        customer_id:
          type: string
          maxLength: 64
          description: معرّف المستخدم داخل النظام.
        metadata:
          type: object
          additionalProperties: true
          description: حقول إضافية للتكامل (بريد، قناة، سياق).
    PaymentIntent:
      type: object
      additionalProperties: false
      required:
        - id
        - status
        - amount
        - currency
        - order_reference
        - created_at
      properties:
        id:
          type: string
          maxLength: 64
          description: Identifier of the payment intent within the wallet service.
        status:
          type: string
          enum:
            - requires_payment_method
            - requires_action
            - processing
            - succeeded
            - failed
            - canceled
          description: Current state of the payment intent.
        amount:
          type: integer
          minimum: 0
          description: Amount in the smallest currency unit.
        currency:
          type: string
          minLength: 3
          maxLength: 3
          description: ISO-4217 currency code.
        order_reference:
          type: string
          maxLength: 64
          description: Reference to the source order in the consuming service.
        created_at:
          type: string
          format: date-time
          description: Creation timestamp (ISO 8601).
        updated_at:
          type: string
          format: date-time
          description: Last update timestamp (ISO 8601).
        metadata:
          type: object
          additionalProperties: true
          description: Provider metadata forwarded from the PSP.
    PaymentConfirmationRequest:
      type: object
      additionalProperties: false
      required:
        - provider_payload
      properties:
        provider_payload:
          type: object
          additionalProperties: true
          description: الرد الأصلي من مزود PSP بعد تنفيذ الدفع.
        reconciliation_reference:
          type: string
          description: رقم المرجع للمصالحة المالية إذا توفر.
    CaptureAdjustRequest:
      type: object
      additionalProperties: false
      required:
        - delta_amount
        - reason_code
      properties:
        delta_amount:
          type: integer
          description: الفرق الذي سيتم تطبيقه على الالتقاط (يمكن أن يكون سالبًا).
        reason_code:
          type: string
          enum:
            - substitution
            - partial_out_of_stock
            - customer_return
            - manual_adjustment
        notes:
          type: string
          maxLength: 256
          description: تعليق اختياري من النظام المستهلك (مثل DSH).
    WltRefundWebhook:
      type: object
      additionalProperties: false
      required:
        - event
        - signature
        - issued_at
        - data
      properties:
        event:
          type: string
          enum:
            - refund.succeeded
            - refund.failed
            - chargeback.opened
            - chargeback.closed
        signature:
          type: string
          description: التوقيع الرقمي المولّد عبر المفتاح السري المشترك.
        issued_at:
          type: string
          format: date-time
        data:
          type: object
          additionalProperties: true
          description: الحمولة التفصيلية للحدث (مبلغ، intent_id، تفاصيل PSP).